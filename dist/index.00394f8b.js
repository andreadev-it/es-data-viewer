var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.Wormhole=e.SystemObject=e.System=e.Planet=e.ParsedData=e.Government=e.Galaxy=e.Color=e.parseFiles=e.parseFile=void 0;var t={};Object.defineProperty(t,"__esModule",{value:!0}),t.parseFiles=t.parseFile=void 0;var n={};Object.defineProperty(n,"__esModule",{value:!0}),n.ParsedData=void 0;n.ParsedData=class{constructor(){this.galaxies=new Map,this.starSystems=new Map,this.colors=new Map,this.governments=new Map,this.planets=new Map,this.wormholes=new Map}addGalaxy(e){this.galaxies.set(e.name,e)}addStarSystem(e){this.starSystems.set(e.name,e)}addColor(e){this.colors.set(e.name,e)}addGovernment(e){this.governments.set(e.name,e)}addPlanet(e){this.planets.set(e.name,e)}addWormhole(e){this.wormholes.set(e.name,e)}};var s={};Object.defineProperty(s,"__esModule",{value:!0}),s.lex=void 0;var i={};Object.defineProperty(i,"__esModule",{value:!0}),i.FileRoot=i.Line=void 0;class o{constructor(e,t){this.tokens=e,this.indentation=t,this.children=[]}toString(){const e=[...this.tokens];let t="";for(const n of e)n.includes(" ")?n.includes('"')?t+="`"+n+"`":t+=`"${n}"`:t+=n+" ";return t}}i.Line=o;i.FileRoot=class extends o{constructor(e,t,n){super(e,t),this.tokens=e,this.indentation=t,this.isRoot=!0,this.filename=n}},s.lex=function(e,t=""){const n=new i.FileRoot([],0,t);let s=!1,o=!1,r="",a=new i.Line([],0),l="",h=[n];for(let t=0;t<e.length;t++){const n=e[t];let c=null;if(!o||"\n"==n)switch(n){case"#":0!=l.length||s||(o=!0);break;case'"':case"`":if(s&&n==r){s=!1,0==l.length&&a.tokens.push("");break}if(!s&&0==l.length){s=!0,r=n;break}if(!s)throw new Error(`Unescaped quote in string after ${l}`);break;case"\n":if(""==l||o||a.tokens.push(l),l="",o=!1,c=new i.Line([],0),0==a.tokens.length){a=c;continue}if(a.indentation>h.length-1)throw new Error(`Unexpected indentation for line ${a.tokens.join(" ")}`);if(a.indentation>=0&&h[a.indentation].children.push(a),a.indentation==h.length-1||(h=h.slice(0,a.indentation+1)),h.push(a),s)throw new Error(`A quote was left open near: '${l}'`);a=c;break;case" ":s?l+=" ":l.length>0&&(a.tokens.push(l),l="");break;case"\t":s||0!=a.tokens.length||0!=l.length?!s&&l.length>0?(a.tokens.push(l),l=""):l+="\t":a.indentation++;break;default:l+=n}}return n};var r={};Object.defineProperty(r,"__esModule",{value:!0}),r.parse=void 0;var a={};Object.defineProperty(a,"__esModule",{value:!0}),a.System=void 0;var l={};Object.defineProperty(l,"__esModule",{value:!0}),l.SystemObject=void 0;class h{constructor(e,t,n,s=0){this.esData=e,this.name="",this.sprite="",this.offset=0,this.objects=[],this.distance=t,this.period=n}static fromLine(e,t){if("object"!=t.tokens[0])throw new Error("Not an object");const n=2==t.tokens.length?t.tokens[1]:"";let s="",i=0,o=0,r=0;const a=[];for(let n of t.children)switch(n.tokens[0]){case"sprite":s=n.tokens[1];break;case"distance":i=parseFloat(n.tokens[1]);break;case"period":o=parseFloat(n.tokens[1]);break;case"offset":r=parseFloat(n.tokens[1]);break;case"object":a.push(h.fromLine(e,n))}const l=new h(e,i,o,r);return l.name=n,l.objects=a,l.sprite=s,l}}l.SystemObject=h;class c{static fromLine(e,t){if("system"!=t.tokens[0])throw new Error("Not a system");const n=t.tokens[1];let s={x:0,y:0},i=!1,o=[],r="",a=[];const h=[];for(let n of t.children)switch(n.tokens[0]){case"pos":s={x:parseInt(n.tokens[1]),y:parseInt(n.tokens[2])},i=!0;break;case"link":o.push(n.tokens[1]);break;case"government":r=n.tokens[1];break;case"attributes":a=n.tokens.slice(1);break;case"object":h.push(l.SystemObject.fromLine(e,n))}if(!i)throw new Error("No position found for this system");const d=new c(e,n,s);return d.links=o,d.government=r,d.attributes=a,d.objects=h,d}constructor(e,t,n){this.links=[],this.government="",this.attributes=[],this.objects=[],this.isSelected=!1,this.name=t,this.position=n,this.esData=e}}a.System=c;var d={};Object.defineProperty(d,"__esModule",{value:!0}),d.Galaxy=void 0;class u{static fromLine(e,t){if("galaxy"!=t.tokens[0])throw new Error("Not a galaxy");const n=t.tokens[1];let s={x:0,y:0},i=!1,o="";for(let e of t.children)"pos"!=e.tokens[0]?"sprite"==e.tokens[0]&&(o=e.tokens[1]):(s={x:parseInt(e.tokens[1]),y:parseInt(e.tokens[2])},i=!0);if(!i)throw new Error("No position found for this system");const r=new u(e,n,s);return r.sprite=o,r}constructor(e,t,n){this.position={x:0,y:0},this.sprite="",this.name=t,this.position=n,this.esData=e}}d.Galaxy=u;var m={};Object.defineProperty(m,"__esModule",{value:!0}),m.Color=void 0;class p{constructor(e,t,n,s,i=255){this.name=e,this.r=t,this.g=n,this.b=s,this.a=i}toString(){return 255==this.a?`rgb(${this.r}, ${this.g}, ${this.b})`:`rgba(${this.r}, ${this.g}, ${this.b}, ${this.a})`}static fromLine(e,t){let n=t.tokens[1],s=parseFloat(t.tokens[2]),i=parseFloat(t.tokens[3]),o=parseFloat(t.tokens[4]),r=255;return 6==t.tokens.length&&(r=parseFloat(t.tokens[5])),p.fromPercentages(n,s,i,o,r)}static fromPercentages(e,t,n,s,i){return new p(e,255*t,255*n,255*s,255*i)}static fromGovernment(e,t){let n=e.governments.get(t);if(!n)return null;if(n.color instanceof p)return n.color;let s=e.colors.get(n.color);return s||null}}m.Color=p;var f={};Object.defineProperty(f,"__esModule",{value:!0}),f.Government=void 0;class g{static fromLine(e,t){if("government"!=t.tokens[0])throw new Error("Not a government");const n=t.tokens[1];let s="";for(let e of t.children)if("color"==e.tokens[0])if(2==e.tokens.length)s=e.tokens[1];else{let e=parseFloat(t.tokens[1]),n=parseFloat(t.tokens[2]),i=parseFloat(t.tokens[3]),o=255;5==t.tokens.length&&(o=parseFloat(t.tokens[4])),s=m.Color.fromPercentages("",e,n,i,o)}const i=new g(e,n);return i.color=s,i}constructor(e,t){this.color="",this.esData=e,this.name=t}}f.Government=g;var v={};Object.defineProperty(v,"__esModule",{value:!0}),v.Planet=void 0;class y{constructor(e,t){this.esData=e,this.name=t,this.wormhole=""}static fromLine(e,t){if("planet"!=t.tokens[0])throw new Error("Not a planet");const n=t.tokens[1];let s="";for(let e of t.children)"wormhole"==e.tokens[0]&&(s=e.tokens[1]);let i=new y(e,n);return i.wormhole=s,i}}v.Planet=y;var k={};Object.defineProperty(k,"__esModule",{value:!0}),k.Wormhole=void 0;class b{constructor(e,t){this.esData=e,this.name=t,this.isMappable=!1,this.links=[],this.color=""}static fromLine(e,t){if("wormhole"!=t.tokens[0])throw new Error("Not a wormhole");const n=t.tokens[1];let s=!1,i="",o=[];for(let e of t.children)switch(e.tokens[0]){case"color":if(2==e.tokens.length)i=e.tokens[1];else{let e=parseFloat(t.tokens[1]),n=parseFloat(t.tokens[2]),s=parseFloat(t.tokens[3]),o=255;5==t.tokens.length&&(o=parseFloat(t.tokens[4])),i=m.Color.fromPercentages("",e,n,s,o)}break;case"link":o.push([e.tokens[1],e.tokens[2]]);break;case"mappable":s=!0}const r=new b(e,n);return r.isMappable=s,r.color=i,r.links=o,r}}k.Wormhole=b,r.parse=function(e,t=null){const s=null!=t?t:new n.ParsedData;for(let t of e.children)"system"==t.tokens[0]?s.addStarSystem(a.System.fromLine(s,t)):"galaxy"==t.tokens[0]?s.addGalaxy(d.Galaxy.fromLine(s,t)):"color"==t.tokens[0]?s.addColor(m.Color.fromLine(s,t)):"government"==t.tokens[0]?s.addGovernment(f.Government.fromLine(s,t)):"planet"==t.tokens[0]?s.addPlanet(v.Planet.fromLine(s,t)):"wormhole"==t.tokens[0]&&s.addWormhole(k.Wormhole.fromLine(s,t));return s};var w={};async function x(e,t,i){const o=null!=i?i:new n.ParsedData;let a=await(0,w.readFile)(e),l=(0,s.lex)(a,t);return(0,r.parse)(l,o),o}Object.defineProperty(w,"__esModule",{value:!0}),w.readFile=void 0,w.readFile=function(e){return new Promise(((t,n)=>{const s=new FileReader;s.onload=()=>{t(s.result)},s.readAsText(e)}))},t.parseFile=x,t.parseFiles=async function(e){const t=new n.ParsedData;for(let n of e)await x(n,n.webkitRelativePath,t);return t},Object.defineProperty(e,"parseFile",{enumerable:!0,get:function(){return t.parseFile}}),Object.defineProperty(e,"parseFiles",{enumerable:!0,get:function(){return t.parseFiles}}),Object.defineProperty(e,"Color",{enumerable:!0,get:function(){return m.Color}}),Object.defineProperty(e,"Galaxy",{enumerable:!0,get:function(){return d.Galaxy}}),Object.defineProperty(e,"Government",{enumerable:!0,get:function(){return f.Government}}),Object.defineProperty(e,"ParsedData",{enumerable:!0,get:function(){return n.ParsedData}}),Object.defineProperty(e,"Planet",{enumerable:!0,get:function(){return v.Planet}}),Object.defineProperty(e,"System",{enumerable:!0,get:function(){return a.System}}),Object.defineProperty(e,"SystemObject",{enumerable:!0,get:function(){return l.SystemObject}}),Object.defineProperty(e,"Wormhole",{enumerable:!0,get:function(){return k.Wormhole}});class P extends EventTarget{constructor(e){super(),this.canvas=e,this.plugins=new Map;const t=this.canvas.getContext("2d");if(null==t)throw"Could not get the context for the canvas";this.context=t}renderCycle(){this.paint(),window.requestAnimationFrame((()=>this.renderCycle()))}use(e,t){const n=new e(this,t);this.plugins.set(n.name,n)}getPlugin(e){for(let t of this.plugins.values())if(t instanceof e)return t}paint(e=!0){this.prepareContext(e);const t={context:this.context};this.preRender(t),this.render(t),this.postRender(t)}prepareContext(e=!0){this.context.resetTransform(),e&&this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.translate(Math.floor(this.canvas.width/2),Math.floor(this.canvas.height/2))}on(e,t){this.addEventListener(e,t)}startRendering(){window.requestAnimationFrame((()=>this.renderCycle()))}preRender(e){const t=new CustomEvent("prerender",{detail:e});this.dispatchEvent(t)}render(e){const t=new CustomEvent("render",{detail:e});this.dispatchEvent(t)}postRender(e){const t=new CustomEvent("postrender",{detail:e});this.dispatchEvent(t)}}function L(e,t){let n,s=!1;return function(){if(s)return;const i=arguments;e.apply(this,i),clearTimeout(n),n=setTimeout((()=>s=!1),t),s=!0}}class S{constructor(e,t){var n,s,i;this.app=e,this.settings=t,this.name="PanZoom",this.currentZoom=1,this.minZoom=.1,this.maxZoom=10,this.panButton=1,this.cameraOffset={x:0,y:0},this.isPanning=!1,this.startedPanningOffset={x:0,y:0},this.startedPanningPosition={x:0,y:0},this.throttle=-1,this.bindEvents(),this.minZoom=null!==(n=t.minZoom)&&void 0!==n?n:this.minZoom,this.maxZoom=null!==(s=t.maxZoom)&&void 0!==s?s:this.maxZoom,this.throttle=null!==(i=t.throttle)&&void 0!==i?i:this.throttle,this.throttledPaint=L(this.app.paint.bind(this.app),this.throttle);t.panButton&&(this.panButton={left:0,middle:1,right:2,any:-1}[t.panButton])}bindEvents(){this.app.on("prerender",this.transformCanvas.bind(this)),this.app.canvas.addEventListener("pointerdown",this.onPointerDown.bind(this)),this.app.canvas.addEventListener("pointerup",this.onPointerUp.bind(this)),this.app.canvas.addEventListener("pointermove",this.onPointerMove.bind(this)),this.app.canvas.addEventListener("pointerleave",this.onPointerUp.bind(this)),this.app.canvas.addEventListener("wheel",this.onScroll.bind(this))}screenToLocalPoint(e,t){let n=this.app.canvas.width/2,s=this.app.canvas.height/2,i=this.cameraOffset.x,o=this.cameraOffset.y,r=this.currentZoom;return e-=n,t-=s,e/=r,t/=r,{x:e-=i,y:t-=o}}zoom(e){this.currentZoom+=e,this.currentZoom=Math.min(Math.max(this.minZoom,this.currentZoom),this.maxZoom),this.currentZoom=Math.floor(1e3*this.currentZoom)/1e3,this.updateRender()}transformCanvas(e){e.detail.context.scale(this.currentZoom,this.currentZoom),e.detail.context.translate(this.cameraOffset.x,this.cameraOffset.y)}onPointerDown(e){e.button!=this.panButton&&-1!=this.panButton||(this.isPanning=!0,this.startedPanningOffset=this.cameraOffset,this.startedPanningPosition={x:e.clientX,y:e.clientY})}onPointerUp(e){this.isPanning=!1}onPointerMove(e){this.isPanning&&(this.cameraOffset={x:this.startedPanningOffset.x+(e.clientX-this.startedPanningPosition.x)/this.currentZoom,y:this.startedPanningOffset.y+(e.clientY-this.startedPanningPosition.y)/this.currentZoom},this.updateRender())}onScroll(e){this.zoom(e.deltaY/1e3)}updateRender(){this.throttle>0?this.throttledPaint():this.app.paint()}static getDataFromMatrix(e){return{scaleX:e.a,scaleY:e.d,translateX:e.e,translateY:e.f,skewX:e.b,skewY:e.c}}static fixedNumber(e,t,n="x"){let{scaleX:s,scaleY:i}=this.getDataFromMatrix(t.getTransform());return"x"==n?e*(1/s):e*(1/i)}static fixedSize(e,t,n){let{scaleX:s,scaleY:i}=this.getDataFromMatrix(n.getTransform());return{width:e*(1/s),height:t*(1/i)}}}const E=3,M=2,O=4,R="rgba(255,255,255,0.3)",j=12;function C(e,t){return Math.sqrt(Math.pow(e.position.x-t.x,2)+Math.pow(e.position.y-t.y,2))}function D(e,t){t.beginPath(),t.fillStyle="rgba(100,100,255,0.2)",t.strokeStyle="darkblue",t.lineWidth=S.fixedNumber(1,t);let n=S.fixedNumber(15,t);t.ellipse(e.position.x,e.position.y,n,n,0,0,2*Math.PI),t.fill(),t.stroke()}function F(t,n){let s=e.Color.fromGovernment(t.esData,t.government)?.toString();s||(s="#aaa"),n.beginPath(),n.fillStyle="black",n.strokeStyle=s,n.lineWidth=S.fixedNumber(M,n);let{width:i,height:o}=S.fixedSize(E,E,n);n.ellipse(t.position.x,t.position.y,i,o,0,0,2*Math.PI),n.fill(),n.stroke()}function _(e,t){let{scaleX:n}=S.getDataFromMatrix(t.getTransform());if(n<.5)return;let s=S.fixedNumber(j,t);t.font=`${s}px Arial`,t.fillStyle=R;let i=S.fixedNumber(O,t),{width:o,height:r}=S.fixedSize(E,E,t);t.fillText(e.name,e.position.x+o+i,e.position.y+r)}async function G(e,t,n){if(""==e.sprite)return;let s=t.loadedSprites.get(e.sprite);if(!s){const n=t.sprites.get(e.sprite);if(!n)return void console.error(`Sprite ${e.sprite} not found`);s=await t.load(e.sprite,n)}n.drawImage(s,e.position.x-s.width/2,e.position.y-s.height/2)}class I extends EventTarget{constructor(e,t,n){super(),this.esData=e,this.spriteList=t,this.canvasLib=n,this.shouldRenderNames=!0,this.shouldRenderLinks=!0,this.shouldRenderDots=!0,this.shouldRenderGalaxies=!0,this.shouldRenderWormholeLinks=!0,this.shouldRenderHiddenWormholes=!1,this.currentlySelected=null,this.systemLinksCache=new Set,this.canvasLib.canvas.addEventListener("pointerdown",this.onCanvasClick.bind(this))}async activate(){document.getElementById("toggle-galaxies")?.addEventListener("change",this.toggleGalaxies.bind(this)),document.getElementById("toggle-pins")?.addEventListener("change",this.toggleDots.bind(this)),document.getElementById("toggle-names")?.addEventListener("change",this.toggleNames.bind(this)),document.getElementById("toggle-links")?.addEventListener("change",this.toggleLinks.bind(this)),document.getElementById("toggle-wormholes")?.addEventListener("change",this.toggleWormholes.bind(this)),document.getElementById("toggle-hidden-wormholes")?.addEventListener("change",this.toggleHiddenWormholes.bind(this)),this.buildSystemLinksCache(),await this.preloadGalaxySprites()}async deactivate(){}toggleNames(e){this.shouldRenderNames=e.target.checked,this.canvasLib.paint()}toggleLinks(e){this.shouldRenderLinks=e.target.checked,this.canvasLib.paint()}toggleDots(e){this.shouldRenderDots=e.target.checked,this.canvasLib.paint()}toggleGalaxies(e){this.shouldRenderGalaxies=e.target.checked,this.canvasLib.paint()}toggleWormholes(e){this.shouldRenderWormholeLinks=e.target.checked,this.canvasLib.paint()}toggleHiddenWormholes(e){this.shouldRenderHiddenWormholes=e.target.checked,this.canvasLib.paint()}onCanvasClick(e){if(0!==e.button)return;let t=this.canvasLib.getPlugin(S);if(!t)return;let n=t.screenToLocalPoint(e.clientX,e.clientY),s=null,i=1e4,o=10,r=this.canvasLib.canvas.getContext("2d");r&&(o=S.fixedNumber(10,r));for(let e of this.esData.starSystems.values()){let t=C(e,n);t>o||(!s||t<i)&&(s=e,i=t)}s?this.selectSystem(s):this.removeSelection()}removeSelection(){this.currentlySelected&&(this.currentlySelected.isSelected=!1,this.currentlySelected=null,this.canvasLib.paint())}selectSystem(e){this.currentlySelected=e,this.updateStarSystemInfo(e),this.canvasLib.paint()}updateStarSystemInfo(e){document.querySelector("#system-name .value").textContent=e.name,document.querySelector("#system-position .value").textContent=`${e.position.x} - ${e.position.y}`,document.querySelector("#system-government .value").textContent=e.government,document.querySelector("#system-attributes .value").textContent=e.attributes.join(", ")}buildSystemLinksCache(){this.systemLinksCache=new Set;for(let e of this.esData.starSystems.values())for(let t of e.links){let n=`${e.name}___${t}`,s=`${t}___${e.name}`;this.systemLinksCache.has(s)||this.systemLinksCache.add(n)}}async preloadGalaxySprites(){for(let e of this.esData.galaxies.values()){let t=this.spriteList.sprites.get(e.sprite);t&&await this.spriteList.load(e.sprite,t)}}async preRender(e){if(this.esData){if(this.shouldRenderGalaxies)for(let t of this.esData.galaxies.values())await G(t,this.spriteList,e);if(this.shouldRenderLinks){e.lineWidth=S.fixedNumber(1,e),e.strokeStyle="rgba(255,255,255,0.2)";for(let t of this.systemLinksCache.values()){let[n,s]=t.split("___"),i=this.esData.starSystems.get(n),o=this.esData.starSystems.get(s);o&&i&&(e.beginPath(),e.moveTo(i.position.x,i.position.y),e.lineTo(o.position.x,o.position.y),e.stroke())}}if(this.shouldRenderWormholeLinks){e.lineWidth=S.fixedNumber(1,e),e.strokeStyle="rgba(100,100,255,0.5)";for(let t of this.esData.wormholes.values())if(t.isMappable||this.shouldRenderHiddenWormholes)for(let n of t.links){let[t,s]=n,i=this.esData.starSystems.get(t),o=this.esData.starSystems.get(s);o&&i&&(e.beginPath(),e.moveTo(i.position.x,i.position.y),e.lineTo(o.position.x,o.position.y),e.stroke())}}}}render(e){if(this.esData)for(let t of this.esData.starSystems.values())this.currentlySelected==t&&D(t,e),this.shouldRenderDots&&F(t,e),this.shouldRenderNames&&_(t,e)}postRender(e){}}const N={galaxy:null};let W=null;function Z(e){let t=e.getBoundingClientRect();e.width=t.width,e.height=t.height;const n=new P(e);n.use(S,{});return n.on("prerender",(e=>{W?.preRender(e.detail.context)})),n.on("render",(async e=>{W?.render(e.detail.context)})),n.on("postrender",(async e=>{W?.render(e.detail.context)})),n}async function $(e,t,n){N.galaxy=new I(n,t,e),await async function(e){await(W?.deactivate()),W=e,await W.activate()}(N.galaxy),e.paint()}const B=async()=>new Promise((e=>{const t=document.createElement("input");t.type="file",t.webkitdirectory=!0,t.addEventListener("change",(()=>{let n=Array.from(t.files);e(n)})),"showPicker"in HTMLInputElement.prototype?t.showPicker():t.click()}));function T(e){return new Promise(((t,n)=>{let s=new Image;s.onload=()=>{t(s)},s.onerror=()=>{n()},s.src=URL.createObjectURL(e)}))}class X{sprites=new Map;loadedSprites=new Map;constructor(){}async load(e,t){let n=await T(t);return this.loadedSprites.set(e,n),n}}let Y=null;async function q(){const t=await B(),n=t.filter((e=>null!=e.webkitRelativePath.match(/^([^\/]*\/)?data\//))),s=await(0,e.parseFiles)(n),i=function(e){const t=new X;for(let n of e)if(n.webkitRelativePath.includes("images/")){let e=n.webkitRelativePath.split("images/")[1];e=e.replace(/([+\-~])?\.\w+$/,""),t.sprites.set(e,n)}return t}(t);let o=document.getElementById("viewer");var r;Y=Z(o),$(Y,i,s),r=Y,document.getElementById("zoom-in")?.addEventListener("click",(()=>{const e=r.getPlugin(S);e&&e.zoom(.2)})),document.getElementById("zoom-out")?.addEventListener("click",(()=>{const e=r.getPlugin(S);e&&e.zoom(-.2)})),document.getElementById("viewer")?.addEventListener("pointerdown",(e=>{const t=r.getPlugin(S);t&&console.log(t.screenToLocalPoint(e.clientX,e.clientY))}))}document.getElementById("select-file")?.addEventListener("click",(()=>{q()}));
//# sourceMappingURL=index.00394f8b.js.map
